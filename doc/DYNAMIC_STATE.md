# 动态状态系统 (Dynamic State System)

## 概述

动态状态系统模拟了真实足球中球队和球员在赛季中的状态波动，包括连胜/连败的势头、疲劳累积、士气变化等因素。

## 核心特性

### 1. 球队动态状态 (TeamDynamicState)

#### 连胜/连败势头 (Streak)
- **连胜加成**: 每多赢一场，士气额外提升
- **连败惩罚**: 每多输一场，士气下降更多
- **记录追踪**: 记录赛季最长连胜和连败

```python
# 示例: 球队状态变化
初始状态: 士气 50, 连胜 0

连胜3场后:
  士气: 50 + (5 + 1.5*1) + (5 + 1.5*2) + (5 + 1.5*3) = 72.5
  
连败2场后:
  士气: 72.5 + (-5 + 1.5*(-1)) + (-5 + 1.5*(-2)) = 57.5
```

#### 士气系统 (Morale)
- 范围: 10-100
- 影响: 球队整体表现 +/- 20%
- 变化因素:
  - 比赛结果 (胜+5, 负-5, 平0)
  - 连胜/连败加成
  - 表现超出预期 (+/-)

#### 主客场状态 (Home/Away Form)
- 分别追踪主场和客场表现
- 影响主客场优势 (最多 +/- 10%)
- 近期表现权重更高 (70%历史 + 30%最近)

### 2. 球员动态状态 (PlayerMatchState)

#### 疲劳累积 (Fatigue)
```python
# 每场比赛后:
体能损失 = 出场分钟数 × 0.3
# 90分钟比赛约损失 27 点体能

# 每周恢复:
恢复量 = 天数 × 12 (疲劳时额外+3)
# 一周约恢复 84 点体能
```

#### 状态波动 (Form)
- 最近5场比赛的加权平均
- 影响球员表现预期
- 范围: 10-100

#### 信心值 (Confidence)
- 基于近期表现
- 表现好 (+2), 表现差 (-3)
- 影响关键时刻发挥

#### 伤病风险 (Injury Risk)
```
基础风险: 2%
疲劳加成: +0% 到 +4% (疲劳时翻倍)
实际风险: 2% × (1 + 疲劳度/50)
```

### 3. 状态影响比赛

#### 球队状态修改器
```python
总修改器 = 士气修改器 + 势头修改器

# 士气修改器 (基于士气值)
0.9 + (士气 / 100) × 0.2 = 0.9 到 1.1 (±10%)

# 势头修改器 (基于连胜/连败)
连胜: +每连胜一场 2% (最高 10%)
连败: -每连败一场 2% (最高 10%)
```

#### 阵容选择逻辑
```python
有效评分 = 基础能力 + 状态加成 - 疲劳惩罚

状态加成 = (状态 - 50) / 100 × 10  # +/- 10点
疲劳惩罚 = (100 - 体能) × 0.2      # 最高 20点

# 优先选择有效评分高的球员
```

## 实际效果展示

### 案例 1: 冠军球队
```
Manchester City:
  - 最终积分: 80分
  - 最长连胜: 7场
  - 士气变化: 50 → 100
  - 主场优势: 60 → 73
  - 客场表现: 55 → 72
```

### 案例 2: 状态起伏
```
Brighton:
  - 早期表现: 平均 45分
  - 赛季末表现: 平均 67分 (+22提升)
  - 原因: 中期一波连胜提升了士气

Bournemouth:
  - 早期表现: 平均 60分
  - 赛季末表现: 平均 27分 (-33下降)
  - 原因: 遭遇连败后士气崩溃
```

### 案例 3: 激烈竞争
```
Title Race:
  1. Manchester City: 80 pts (士气 100)
  2. Manchester United: 77 pts (+4连胜)
  3. Newcastle United: 76 pts
  
  差距: 仅3分！曼联最后阶段4连胜仍未能反超
```

## 赛季故事案例

### 逆袭故事
某支中游球队：
- 前10轮: 排名第15，士气 35
- 中期连胜: 5连胜后士气升至 70
- 最终排名: 第7名，获得欧联资格

### 崩盘故事
某支争冠球队：
- 前20轮: 排名第1，士气 90
- 关键伤停: 主力受伤，3连败
- 士气崩溃: 降至 40
- 最终排名: 第5名，无缘欧冠

## 与真实足球的对比

| 现象 | 真实足球 | 本系统 |
|-----|---------|--------|
| 连胜势头 | 存在 (信心提升) | ✅ 士气+连胜加成 |
| 连败困境 | 存在 (恶性循环) | ✅ 士气下滑+负面循环 |
| 主场优势 | 存在 (球迷+熟悉) | ✅ 主场状态单独追踪 |
| 疲劳轮换 | 重要 | ✅ 体能系统+阵容调整 |
| 冬季低迷 | 常见 | ✅ 疲劳累积效应 |
| 赛季末冲刺 | 常见 | ✅ 状态波动 |

## 使用方式

```bash
# 查看赛季故事 (包含动态状态分析)
python scripts/show_season_story.py

# 普通赛季模拟 (自动使用动态状态)
python scripts/simulate_season.py --league "Premier League"

# 关闭动态状态 (对比效果)
# 在代码中设置 use_dynamic_states=False
```

## 技术实现

```python
from fm_manager.engine.season_simulator import SeasonSimulator
from fm_manager.engine.team_state import TeamStateManager

# 模拟器自动管理状态
simulator = SeasonSimulator(session)
result = await simulator.simulate_season(
    league_id=1,
    season_year=2024,
    use_dynamic_states=True,  # 启用动态状态
)

# 查看某支球队的状态变化
state = result.team_states[club_id]
print(f"士气: {state.morale}")
print(f"连胜: {state.current_streak}")
print(f"主场状态: {state.home_form}")
```

## 未来扩展

- [ ] **更衣室氛围**: 球员关系影响团队士气
- [ ] **媒体压力**: 负面新闻影响球队状态
- [ ] **关键球员**: 核心球员伤停对士气打击更大
- [ ] **德比效应**: 重要比赛胜利/失败影响加倍
- [ ] **教练因素**: 换帅后士气重置/提升
- [ ] **天气影响**: 连续客场/恶劣天气增加疲劳
