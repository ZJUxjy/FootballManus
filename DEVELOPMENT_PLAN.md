# 开发计划

## 总体时间线

```
Phase 1 (2-3周)      Phase 2 (2周)       Phase 3 (3周)       Phase 4 (2周)       Phase 5 (持续)
    │                    │                   │                   │                   │
    ▼                    ▼                   ▼                   ▼                   ▼
┌──────────┐        ┌──────────┐       ┌──────────┐       ┌──────────┐       ┌──────────┐
│ 数据层   │   ──▶  │ 比赛引擎 │  ──▶  │ 系统核心 │  ──▶  │ LLM集成  │  ──▶  │ 完善优化 │
│ 基础设施 │        │ 验证     │       │ ✅ 完成  │       │ 叙事系统 │       │ 迭代     │
└──────────┘        └──────────┘       └──────────┘       └──────────┘       └──────────┘
        ✅ 完成            ✅ 完成            ✅ 完成              ⏳ 当前
```

---

## ✅ Phase 1: 数据层与基础设施 (已完成)

### 完成内容
- [x] 项目骨架搭建
- [x] SQLAlchemy 模型 (Player, Club, League, Match, Transfer)
- [x] 数据库迁移脚本
- [x] 数据导入系统
- [x] 2,779 球员，95 俱乐部，5 联赛

---

## ✅ Phase 2: 比赛模拟器 (已完成)

### 完成内容
- [x] 球队实力计算系统 (阵容、化学、战术)
- [x] 比赛引擎 V1 (直接概率)
- [x] 比赛引擎 V2 (射门机制) ⭐ 当前使用
- [x] 赛季模拟系统
- [x] 动态状态系统 (连胜/连败、士气、疲劳)
- [x] 验证测试 (胜率45%/平局26%/冷门22%)

---

## ✅ Phase 3: 核心系统 (已完成)

### Week 6: 财政系统 ✅
- [x] 收入计算
  - [x] 门票收入 = 票价 × 上座率 × 容量
  - [x] 转播分成 (按排名，最高€18M/场)
  - [x] 商业赞助 (基于声望，最高€577K/周)
- [x] 支出计算
  - [x] 周薪发放
  - [x] 青训维护费
  - [x] 设施维护费
- [x] 财政公平 (FFP) 检查
  - [x] 三年滚动盈亏计算
  - [x] 违规检测与制裁
- [x] 预算系统
  - [x] 转会预算/工资预算分配
  - [x] 财务健康度评估

### Week 7: 转会系统 ✅
- [x] 转会引擎
  - [x] 报价发起/接受/拒绝/还价逻辑
  - [x] 球员估值算法 (能力/年龄/合同/需求)
  - [x] AI 报价生成
- [x] 合同系统
  - [x] 工资谈判 (基于声望/表现/年龄)
  - [x] 合同期限/解约金
  - [x] 签字费/奖金
  - [x] 球员接受度评估
- [x] 转会窗口
  - [x] 夏窗 (6月1日 - 9月1日)
  - [x] 冬窗 (1月1日 - 2月1日)
  - [x] 窗口天数计算

### Week 8: 青训系统 ✅
- [x] 青训球员生成
  - [x] 基于学院等级生成潜力
  - [x] 位置/国籍分布
  - [x] 年龄范围 (14-17岁)
- [x] 球员成长系统
  - [x] 年龄成长曲线 (18-22峰值)
  - [x] 比赛时间影响
  - [x] 训练质量影响
  - [x] 年龄衰退 (30+)
- [x] 球探系统
  - [x] 区域球探任务
  - [x] 球探报告生成
  - [x] 能力/潜力评估 (带误差)

### 交付物
- [x] `finance_engine.py` - 完整财政系统
- [x] `transfer_engine.py` - 完整转会系统
- [x] `youth_engine.py` - 完整青训系统
- [x] `test_core_systems.py` - 综合测试
- [x] `doc/FINANCE_SYSTEM.md` - 财政设计文档

---

## ⏳ Phase 4: LLM 集成 (第9-10周) - 当前阶段

### Week 9: 叙事系统

#### Day 1-2: LLM 客户端基础
- [ ] OpenAI/Claude API 封装
- [ ] 响应缓存机制
- [ ] 错误处理与重试
- [ ] Token 使用监控

#### Day 3-4: 比赛叙事生成
- [ ] 比赛事件叙事化
  - [ ] 进球时刻描述
  - [ ] 关键扑救描述
  - [ ] 红黄牌事件描述
- [ ] 球员表现点评
- [ ] 战术调整描述

#### Day 5-6: 赛季故事线
- [ ] 赛季回顾生成
- [ ] 关键比赛故事
- [ ] 球员成长故事
- [ ] 冠军/降级叙事

#### Day 7: 球员个性
- [ ] 球员性格标签
- [ ] 转会传闻生成
- [ ] 采访/声明生成

### Week 10: AI 对手管理

#### Day 1-3: AI 俱乐部管理
- [ ] AI 转会决策
  - [ ] 根据需求寻找球员
  - [ ] 报价策略
  - [ ] 球员出售决策
- [ ] AI 战术调整
  - [ ] 根据对手调整阵容
  - [ ] 比赛中的战术变化
- [ ] AI 青训投入
  - [ ] 学院升级决策
  - [ ] 青训球员提拔

#### Day 4-5: 新闻系统
- [ ] 新闻生成器
  - [ ] 比赛结果报道
  - [ ] 转会新闻
  - [ ] 伤病更新
- [ ] 新闻影响力系统
  - [ ] 对球员士气影响
  - [ ] 对董事会满意度影响

#### Day 6-7: 球迷与董事会系统
- [ ] 球迷情绪追踪
  - [ ] 基于成绩的情绪变化
  - [ ] 对转会的反应
- [ ] 董事会期望
  - [ ] 赛季目标设定
  - [ ] 财政健康要求
  - [ ] 经理评价系统

#### 交付物
- [ ] `llm_client.py` - LLM 客户端
- [ ] `narrative_engine.py` - 叙事引擎
- [ ] `ai_manager.py` - AI 经理系统
- [ ] `news_system.py` - 新闻系统
- [ ] `fan_board_system.py` - 球迷与董事会

---

## 📋 Phase 5: 完善与迭代 (第11周+ 持续)

### 功能完善
- [ ] 欧冠/欧联赛制
- [ ] 国内杯赛
- [ ] 国家队比赛
- [ ] 球员伤病系统
- [ ] 球员化学反应
- [ ] 成就系统
- [ ] 存档/读档

### 性能优化
- [ ] 数据库查询优化
- [ ] 比赛模拟性能
- [ ] LLM 响应优化
- [ ] 内存使用优化

### 多人联机 (可选)
- [ ] FastAPI WebSocket 服务
- [ ] 房间管理系统
- [ ] 状态同步机制

---

## 技术里程碑检查点

| 检查点 | 状态 | 验证标准 |
|-------|------|---------|
| CP1 | ✅ | 数据库可创建，模型验证通过 |
| CP2 | ✅ | 包含2,779球员的完整数据库 |
| CP3 | ✅ | 模拟器输出合理比赛结果 |
| CP4 | ✅ | 财政/转会/青训系统测试通过 |
| CP5 | ⏳ | AI叙事系统可生成比赛故事 |
| CP6 | ⏳ | 发布 MVP 版本 |

---

## 当前优先级

### 🔥 最高优先级 (立即开始)
1. LLM 客户端封装
2. 比赛叙事生成
3. AI 转会决策

### ⚡ 高优先级 (本周)
4. 赛季故事线生成
5. 新闻系统
6. 球迷情绪系统

### 📋 中优先级 (下周)
7. AI 战术调整
8. 董事会系统
9. 球员个性系统

### 📅 低优先级 (后续)
10. 欧冠/欧联赛制
11. 国内杯赛
12. 多人联机

---

## 引擎模块总览

```
fm_manager/engine/
├── match_engine_v2.py      # 比赛模拟 ✅
├── season_simulator.py     # 赛季模拟 ✅
├── team_state.py           # 动态状态 ✅
├── finance_engine.py       # 财政系统 ✅
├── transfer_engine.py      # 转会系统 ✅
├── youth_engine.py         # 青训系统 ✅
├── llm_client.py           # LLM 客户端 ⏳
├── narrative_engine.py     # 叙事引擎 ⏳
├── ai_manager.py           # AI 经理 ⏳
├── news_system.py          # 新闻系统 ⏳
└── fan_board_system.py     # 球迷董事会 ⏳
```

## 文档结构

```
doc/
├── MATCH_SIMULATION_ANALYSIS.md    # 比赛模拟分析 ✅
├── DYNAMIC_STATE.md                # 动态状态系统 ✅
├── SEASON_SIMULATION.md            # 赛季模拟 ✅
├── FINANCE_SYSTEM.md               # 财政系统 ✅
├── TRANSFER_SYSTEM.md              # 转会系统 ⏳
├── YOUTH_SYSTEM.md                 # 青训系统 ⏳
├── LLM_INTEGRATION.md              # LLM 集成 ⏳
└── NARRATIVE_SYSTEM.md             # 叙事系统 ⏳
```
